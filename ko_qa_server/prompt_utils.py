from __future__ import annotations

prompt_list = {
    "keyword_extract_prompt":
        f"""
请阅读下面的问题，分析并仅提取出能准确反映问题核心实体和概念的关键词。要求：
1. 关键词应集中描述问题的主题和主要对象，不包含描述解决方案、操作性或预期措施的词汇（例如“应对措施”、“怎么办”等）。
2. 每个关键词可以是一个词或一个短语；
3. 输出时请只给出关键词，关键词之间使用逗号隔开，不附加任何其他说明或文字。

示例：
问题：如何提高人工智能在医疗诊断中的应用效率？
回答: 人工智能, 医疗诊断

问题：小明和小王是什么关系？
回答: 小明, 小王

问题：变压器发出吱吱声应该怎么办？
回答: 变压器, 吱吱声

请根据上述要求对下述问题进行分析并直接输出关键词：
""",
    "Chitchat_prompt":
        f"""
你是专门为供电运维设计的轨道交通故障诊断系统顾问，负责为地铁、轻轨等轨道交通系统提供故障诊断与处理方案。
现在需要你处理闲聊场景问答和我的知识库无法回答的问题。
1. 如果问题是闲聊，就正常回答。
2. 如果问题属于轨道交通故障诊断类型，请你针对问题进行你的回答。
3. 回答时始终保持专业、严谨，注重安全性与可靠性。 
4. 若被问及身份或知识截止日期，统一回复：
   “我是一位专业的轨道交通故障诊断系统顾问，专注于地铁、轻轨等轨道交通系统的故障诊断和处理。我会持续更新轨道交通领域的专业知识，为您提供准确的技术支持。”
5. 遇到不确定的问题，明确告知用户“目前无法回答”即可，无需额外说明。  
    """,
    "kdzn_yitu_file": """### 任务描述:
你将扮演一个电气诊断系统中的意图识别器，任务是分析用户输入的文本并识别其意图。用户的输入文本可能属于闲聊或者系统问答中的多种场景：
1. 闲聊（Chitchat）：用户在进行普通的对话，聊天或表达感受，这些内容与特定的系统任务无关。
2. 系统问答：用户在询问与电气（轨电交通、电压器等电气部件）有关的专业性问题，你需要根据提供的输入，选择最相关的文件。注意【典型故障】中可能包含其他文件中的领域信息，如果问题既和典型故障相关，又涉及具体文件，请将典型故障和具体领域的文件一起加入答案。每个文件的信息描述如下：

    2.1.典型故障：变压器本体、电抗器、互感器、套管等变压器部件及其他充油电气设备的故障类型和对应的异常现象，以及故障现象所对应的故障原因。故障类型包括局部/低能量/高能量放电、和过热放热等。可能需要通过分析油中溶解气体的含量和变化情况，来判断设备是否存在故障以及故障类型。

    2.2.干式电力变压器试验：对干式电力变压器进行的多种例行试验、多种型式试验和多种特殊试验。

    2.3.油侵式电力变压器试验：对油侵式电力变压器进行的多种例行试验、多种型式试验和多种特殊试验。

    2.4.绝缘油试验：绝缘油的试验项目及对应的要求和执行标准。包括油中溶解气体色谱分析、击穿电压、水分含量、介质损耗因数、体积电阻率、颗粒度含量、闪点、水溶性酸pH值、酸值、油中含气量和腐蚀性硫等试验项目，以及各自的要求和执行标准。

    2.5.不停电检查：变压器的多个检查部位及相应检查周期、检查项目和要求。涉及变压器本体、冷却装置、套管、吸湿器、无励磁分接开关、有载分接开关、开关在线滤油装置、压力释放阀、气体继电器、端子箱和控制箱、在线监测装置和红外测温等多个检查部位，以及温度、油位、渗漏油等诸多检查项目。

    2.6.停电检查：电力变压器不同部位停电检查的检查周期、项目和具体要求。涉及变压器本体、风冷却装置、水冷却器、套管、分接开关、气体继电器、压力释放阀、温度控制器等多个部位的检查。

    2.7.绕组变形检查：绕组发生异常（电抗或阻抗变化明显、频响特性异常、绕组之间或对地电容量变化明显）时可能的异常原因（a）运输中受到冲击; b）短路电流冲击。），以及相应的检查方法、部位和判断措施。

    2.8.声音异常检查：电力变压器的本体或冷却器发生不同异常声音现象的可能异常原因以及对应的检查方法部位和判断措施。异常现象包括连续高频尖锐声、异常增大且明显杂音、“吱吱”或“噼啪”声、“嘶嘶”声、“哺咯”的沸腾声、“哇哇”声、油泵均匀的周期性“咯咯”金属摩擦声、油泵的无规则非周期性金属摩擦声和油路管道内的“哄哄”声。

    2.9.放电性异常检查：放电性异常相关的异常原因（如“油泵”、“悬浮杂质”、“油流”、“有载分接开关绝缘筒”、“导电回路”、“铁心”、“金属尖端”、“气泡”、“绕组或引线”、“油箱磁屏蔽”和“油流”等发生放电性异常）、以及相关的检查方法部位和判断措施，涉及油中溶解气体分析、油泵运行检查、绕组绝缘电阻测试等多种检测方法。

    2.10.绝缘受潮异常检查：油中含水量超过注意值、绝缘电阻下降、泄露电流增加、变压器本体介质损耗因数增大、油耐压下降这种异常的检查方法、部位及对应的判断措施。

    2.11.过热性异常检查：变压器的异常现象（“总烃超过注意值并持续增长、油中溶解气体分析提示过热、温升超标等过热”）、对用的可能异常原因、检查内容和部位，以及相应的判断与措施。主要涉及铁心多点接地、铁心局部短路、导电回路接触不良、导线股间短路、油道堵塞、接触不良、构件或屏蔽形成短路环、油泵轴承磨损、漏磁回路异物、有载分接开关绝缘筒渗漏等问题的诊断和处理方法。

    2.12.器身检修：电压器的不同部位（如绕组、引线及绝缘支架、铁心、油箱内外以及油箱管道和油箱密封等部位）的检修内容及其对应的检修方法和工艺质量要求。

    2.13.组件部件检修：对电力变压器组件部件检修的详细规程，涵盖了纯瓷套管、油纸电容型套管、套管型电流互感器、储油柜、吸湿器、净油器、散热器、油冷却器、水冷却器、潜油泵、油流继电器、风机、冷却装置控制箱、指针式油位计、气体继电器、压力式温度计、温度控制器、压力释放装置、突发压力继电器、二次端子箱、阀门及塞子等多个部件在其不同部位的检修内容及相应工艺质量要求。

    2.14.气体绝缘金属封闭开关设备状态评价导则：涉及对运行中气体绝缘金属封闭开关设备状态量信息分类、状态评价分类、状态评价基本要求、状态量的量化标准、部件及整体的评价等内容。包括了对气体绝缘金属封闭开关设备（GIS）等部位异常放电声音、内部异常声音、红外热像检测等多种典型缺陷的评价关键点以及异常状态评价等级。以及对气体绝缘金属封闭开关设备状态量的重要程度和劣化程度进行分级的方法。

    2.15.常见异常：涉及对运行中设备的常见异常现象、异常原因及其相应处理措施的分类和总结，内容包括常见异常现象的归纳、典型异常原因的判定方法以及对异常状态的处置方式。包括了如主机显示屏不显示、显示屏黑屏、花屏等多种典型异常现象的具体表现、异常原因的判断关键点以及相应的处理方法。此外，还包括对常见异常现象的优先处理顺序、原因分析的深度和措施的可行性进行分级的基本方法。

    2.16.GIS放电性异常检查：涉及对气体绝缘金属封闭开关设备（GIS）运行状态下放电性异常的检查和判断方法，内容包括典型放电性异常现象的检测、特征识别、原因分析及状态分级。涵盖了如自由金属颗粒放电、悬浮电位体放电、绝缘件内部气隙放电等多种典型放电类型的关键检测特征和原因判断要点，为GIS设备的安全运行提供了重要的状态评价依据和指导性建议。

    2.17.GIS典型故障：涉及对气体绝缘金属封闭开关设备（GIS）典型故障现象的归纳与诊断，内容包括典型异常现象的分类、诊断方法以及判定条件。涵盖如外部异常放电声音、内部异常声音、红外热像异常、局部放电、绝缘受潮等多种典型故障的表现形式，并结合紫外成像检测、特高频局部放电、气体分解产物检测、超声波局部放电等多种检测手段进行综合诊断，明确了各类典型故障的排查和定位关键点，为GIS设备的安全可靠运行提供了有效的技术支撑和指导。

### 要求:
请根据下面的输入文本，判断它属于哪一类。如果属于"闲聊"，请返回 "Chitchat"，返回空的文件列表；如果属于电气诊断系统问答"，请返回"Electric Query"，并给出可以处理该输入的文件列表。

请务必确保输出是紧凑格式的有效 JSON 对象，不包含任何其他解释、转义符、换行符或反斜杠。
### 示例:

输入: "你是谁？你能做什么"
输出: {"意图":"Chitchat", "相关文件":[]}

输入：变压器、互感器、套管过热故障或放电故障的原因是什么？
输出：{"意图":"Electric Query", "相关文件":["典型故障", "过热性异常检查"]}

输入：总烃含量过高，应该怎么维护？
输出：{"意图":"Electric Query", "相关文件":["过热性异常检查"]}

输入: "今天天气真好啊！"
输出: {"意图":"Chitchat", "相关文件":[]}

输入: "绝缘油内湿度有点高，应该怎么处理？"
输出：{"意图":"Electric Query", "相关文件":["绝缘受潮异常检查"]}

输入：变压器接地用铜套与接地护套之间有明显放电痕迹，是什么原因？
输出：{"意图":"Electric Query", "相关文件":["典型故障", "放电性异常检查"]}

输入：电抗或阻抗变化明显，绕组之间或对地电容量变化，对这种现象有什么处理建议？
输出：{"意图":"Electric Query", "相关文件":["绕组变形检查", "器身检修"]}

输入：油泵内部放电有哪些检查措施？
输出：{"意图":"Electric Query", "相关文件":["放电性异常检查"]}

输入：__input__
输出：""",
    "kdzn_input_extract": """**任务**： 在轨电交通智能诊断场景下，需要你从用户输入中提取出关键信息，明确识别出用户所询问的异常现象或部件名称等内容，以及用户想要得到的处理建议或检修方法。
**要求：关键信息提取：** 请从输入文本中抽取出两个主要信息：

   - anchor(异常现象或部件名称)：异常现象（具体对象或现象的描述，有关异常现象的所有信息，例如部件损坏、功能失常、环境因素等）/ 部件名称（用户提到的部件的名字）。
   - requirement(用户的需求)：用户希望获得的解决方案、建议、操作步骤或方法（如“处理建议”或“检修方法”等）。

**请你分析下面的输入内容，提取出以上两个信息。请务必确保输出是紧凑格式的有效 JSON 对象，不包含任何其他解释、转义符、换行符或反斜杠。**

**示例:**

输入: 电抗或阻抗变化明显、频响特性异常、绕组之间或对地电容量变化明显，对这种现象有什么处理建议？
输出: {"anchor":"电抗或阻抗变化明显、频响特性异常、绕组之间或对地电容量变化明显","requirement":"处理建议"}

输入: 油泵内部放电有哪些检查措施
输出: {"anchor":"油泵内部放电","requirement":"检查措施"}

输入: 纯瓷套管应该怎么维护？
输出: {"anchor":"纯瓷套管","requirement":"维护"}

输入: 干式电力变压器都有什么试验项目？
输出: {"anchor":"干式电力变压器","requirement":"试验项目"}

输入: 总烃含量过高，应该怎么维护
输出: {"anchor":"总烃含量过高","requirement":"维护措施"}

输入: 瓷套和导电杆的组装要求
输出: {"anchor":"瓷套和导电杆","requirement":"组装要求"}
**请你参考以上示例，对下面的输入内容进行分析，以JSON格式提取出 anchor 和 requirement 两个关键信息。**

输入: __input__
输出:""",
}
PROMPT_CFG = {
    # 仅知识库
    "kb_only": dict(
        goal="根据提供的知识库匹配到的信息，准确回答用户的问题。如果知识库没有相关信息，请明确告知。",
        role="您扮演的角色是“变压器故障诊断小助手”，专门利用知识库内容为用户提供专业解答。",
        extra_note=""
    ),
    # 知识库 + KO 图谱
    "kb_ko": dict(
        goal="根据提供的知识库匹配到的信息（含 KO 图谱检索结果），准确回答用户的问题。",
        role="您扮演的角色是“变压器故障诊断小助手”，专门利用 KO 图谱和知识库内容为用户提供专业解答。",
        extra_note=""
    ),
    # 知识库 + 联网搜索
    "kb_web": dict(
        goal="根据提供的联网搜索内容以及知识库匹配到的信息，准确回答用户的问题。如果搜索到的内容中没有相关信息，请明确告知。",
        role="您扮演的角色是“变压器故障诊断小助手”，专门利用联网搜索和知识库内容为用户提供专业解答。",
        extra_note="4. 信息来源展示给用户，即将网页连接也输出给用户。"
    ),
    # 知识库 + KO 图谱 + 联网搜索
    "kb_web_ko": dict(
        goal="根据提供的联网搜索内容、KO 图谱以及知识库匹配到的信息，准确回答用户的问题。",
        role="您扮演的角色是“变压器故障诊断小助手”，专门综合三方信息为用户提供专业解答。",
        extra_note="4. 联网搜索内容中的信息来源展示给用户，即将网页连接也输出给用户。"
    ),
    # 仅联网搜索
    "web_only": dict(
        goal="根据提供的联网搜索内容，准确回答用户的问题。如果搜索到的内容中没有相关信息，请明确告知。",
        role="您扮演的角色是“变压器故障诊断小助手”，专门利用联网搜索内容为用户提供专业解答。",
        extra_note="信息来源展示给用户，即将网页连接也输出给用户。"
    ),
    # 仅 KO 图谱
    "ko_only": dict(
        goal="根据提供的 KO 图谱检索结果，准确回答用户的问题。如果图谱中没有相关信息，请明确告知。",
        role="您扮演的角色是“变压器故障诊断小助手”，专门利用 KO 图谱为用户提供专业解答。",
        extra_note=""
    ),
    # 联网搜索 + KO 图谱（无知识库）
    "web_ko_only": dict(
        goal="根据提供的联网搜索内容和 KO 图谱检索结果，准确回答用户的问题。",
        role="您扮演的角色是“变压器故障诊断小助手”，专门综合两方信息为用户提供专业解答。",
        extra_note="信息来源展示给用户，即将网页连接也输出给用户。"
    )
}

# ------------ 2. 公共模板：大段重复文字只写一次 ------------
BASE_PROMPT = """- 目标 -
{goal}

- 角色 -
{role}

- 注意事项 -
（知识库中规则匹配结果用层次结构表示，回答时注意按层次组织回答结构。全局匹配路径中每个路径中`[]`包裹的内容为边(关系)）
1. 充分利用匹配到的信息去回答问题，确保回答与问题完全对应，避免偏离主题。
2. 匹配到的知识存在与问题无关的内容，请注意筛选并充分利用对问题有用的内容。
3. 如果缺乏相关信息，请明确告知用户“由于缺乏相关信息，当前无法准确回答您的问题”。
{extra_note}

- 回答规范 -
1. 对规则匹配结果中的内容不要随意简化或省略，尽可能完整呈现。
2. 如果规则匹配结果过长，不要做简化或总结。
3. 按知识库结构层次用自然语言给出答案。

{web_block}{ko_block}- 知识库 -
{kb_block}

- 问题 -
\"{question}\"
"""


# ------------ 3. 构造可选区块的工具 ------------
def _make_optional_block(title: str, content: str) -> str:
    """没有内容就返回空串，有内容就拼成带 title 的块"""
    if not content:
        return ""
    return f"- {title} -\n{content.strip()}\n\n"


# ------------ 4. build_prompt 主入口 ------------
def build_prompt(
        web_context: str,
        ko_ctx: list[str] | None,
        knowledge_res: str,
        question: str
) -> str:
    """
    根据输入数据生成最终 Prompt
    :param web_context:  联网搜索文本（已拼接成一个字符串；没有就传 ""）
    :param ko_ctx:       KO 图谱检索结果列表；没有就传 []
    :param knowledge_res:规则匹配结果（已经做过 ### 规则匹配结果：xxx 的包装）
    :param question:     用户原始问题
    """
    # 先判定三者是否非空
    has_kb = bool(knowledge_res.strip())
    has_web = bool(web_context.strip())
    has_ko = bool(ko_ctx)

    # 按优先级选 scene_key
    if has_kb and has_web and has_ko:
        scene_key = "kb_web_ko"
    elif has_kb and has_web:
        scene_key = "kb_web"
    elif has_kb and has_ko:
        scene_key = "kb_ko"
    elif has_web and has_ko:
        scene_key = "web_ko_only"
    elif has_web:
        scene_key = "web_only"
    elif has_ko:
        scene_key = "ko_only"
    else:
        scene_key = "kb_only"

    cfg = PROMPT_CFG[scene_key]

    # 2) 组装可选区块
    web_block = _make_optional_block("联网搜索", web_context)
    ko_block = _make_optional_block("KO 图谱", "\n\n".join(ko_ctx) if ko_ctx else "")
    kb_block = knowledge_res or "未检索到任何知识"

    # 3) 渲染模板
    return BASE_PROMPT.format(
        goal=cfg["goal"],
        role=cfg["role"],
        extra_note=cfg["extra_note"],
        web_block=web_block,
        ko_block=ko_block,
        kb_block=kb_block,
        question=question
    )
